<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MaCh3: MCMCconvergance</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="MaCh3.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="mach3logo_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MaCh3
   &#160;<span id="projectnumber">2.4.2</span>
   </div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">MCMCconvergance </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_Doc_User_Guide_11__Step_size_tuning"></a> </p>
<h1><a class="anchor" id="autotoc_md108"></a>
What is and why you need to know what step size tunning</h1>
<p>It is good practice to run an MCMC diagnostic before looking at posterior distributions, although in most cases you will stumble on the need to diagnose after checking posteriors. If your posterior looks like this either you do have not enough steps or wrongly tune the chain. <br  />
 <img src="https://user-images.githubusercontent.com/45295406/213859228-8dbf752d-8c3c-432a-a3d4-2fd33d0f1863.png" alt="" width="400" height="400" class="inline"/></p>
<p>Before discussing step size tunning first we need to understand how a step is proposed.</p><ul>
<li>Gaussian throw - random number drawn from Gauss distribution starting at the previous step multiplied with a spread equal to parameter error.</li>
<li>Correlated throw - the proposed step for two correlated parameters should be more likely to change direction in the same way, hence we include correlation using the Cholesky matrix.</li>
<li>Individual step scale - user selected value for each parameter by a default =1, by step size tunning in most cases we mean modifying this value.</li>
<li>Global step scale - user selected value same cor all parameters in a given covariance class. For example, the value is the same for all xsec-based parameters.</li>
</ul>
<h2><a class="anchor" id="autotoc_md109"></a>
MCMC diagnostic</h2>
<p>There are several plots worth studying for MCMC diagnostic you can find the executables which produce them in the <code>Diagnostics</code> folder, while the text is based on <b>[1]</b>. </p>
<h3><a class="anchor" id="autotoc_md110"></a>
Autocorealtions</h3>
<p>we can study chain autocorrelation, which tells us how much particular steps are correlated. To test it, we introduce a variable <em>Lag(n)= corr(Xi, Xi−n)</em> which tells us how much correlated are steps that are <em>n</em> steps apart, where <em>i</em> is the maximal considered distanced, here <em>i = 25000</em>. Fig. shows autocorrelations for studied chains since we want our steps to be more random, and less correlated to quickly converge. The rule of thumb is for autocorrelation to drop below 0.2 for <em>Lag(n = 10000)</em>. This isn’t a strict criterion so if sometimes autocorrelations drop slightly slower than the blue line in our Figure it’s not a problem. <br  />
</p>
<p>Example of well-tuned step scale (colours represent chains which have different starting positions) <br  />
 <img src="https://user-images.githubusercontent.com/45295406/213926048-896ff3e2-741c-483b-89e6-2c7d025c984e.png" alt="" width="400" height="400" class="inline"/></p>
<p>If your autocorrelation looks like this though you really should increase step size. One exception would be parameter which has no effect. Imagine you run ND only fit but the parameter affects FD only. Then it is expected autocorrelation to look badly. <br  />
 <img src="https://user-images.githubusercontent.com/45295406/213938757-ede5079b-dd6f-4beb-88a7-cd2525ef5805.png" alt="" width="400" height="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md111"></a>
Trace</h3>
<p>Fig. shows the trace which is the value of a chosen parameter at each step. It can be seen that at first, the chains have different traces but after a thousand steps, they start to stabilise and oscillates around a very similar value, indicating that the chain converged and a stationary state was achieved. <br  />
</p>
<p><img src="https://user-images.githubusercontent.com/45295406/213926271-c8ae49c6-4ee3-45d5-a377-79e959ffdc4a.png" alt="" width="400" height="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md112"></a>
AcceptanceProbability Batch</h3>
<p>Fig. shows a mean value of acceptance probability (<em>A(θ',θ)</em>) in an interval of 5k steps (batched mean). This quantity is quite high at the beginning indicating the chain didn’t converge. When the chain gets close to the stationary state it starts to stabilise. Orange stabilised fastest while blue and green are slowly catching up, but the red didn’t converge yet. <br  />
</p>
<p><img src="https://user-images.githubusercontent.com/45295406/213926134-2cecc97b-4e03-4b47-ad58-4cda0d2090ed.png" alt="" width="400" height="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md113"></a>
R Hat</h3>
<p>Usually, we run several chains which are later combined. There is a danger that not all chains will converge then using them will bias results. R hat is meant to estimate whether chains converged successfully or not. According to Gelman, you should calculate R hat for at least 4 chains and if R hat &gt; 1.1 then it might indicate wrong chains convergence. Below you can find an example of chains which wrongly converged and one which successfully</p>
<p>Chains covnerged to different values <img src="https://user-images.githubusercontent.com/45295406/219701548-da171c94-9fa6-4857-8e22-372e278b91dc.png" alt="" width="400" height="400" class="inline"/></p>
<p>Successfuly converged chains <img src="https://user-images.githubusercontent.com/45295406/219701496-abd8070c-616a-4637-ac64-4e1af14dd459.png" alt="" width="400" height="400" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md114"></a>
Geweke</h3>
<p>Geweke Diagnostic helps to define what burn it should it be. You should select burn-in around 15% in this case as this is where distirbution stabilizes. <img src="https://github.com/mach3-software/MaCh3/assets/45295406/61f6f86b-abda-489d-afbd-f758b7ecef27.png" alt="" width="400" height="400" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md115"></a>
Global Step Scale</h2>
<p>According to <b>[2]</b> (Section 3.2.1), the global step size should be equal to 2.38^2/N_params. Keep in mind this refers to the global step scale for a given covariance object like xsec covariance or detector covariance.</p>
<h2><a class="anchor" id="autotoc_md116"></a>
Manual Tunning</h2>
<p>This procedure is very tedious and requires intuition of how a given parameter behaves. It is a bit of dark magic however skilled users should be able to tune it relatively fast compared with the non-skilled user. The process is as follows, you run the chain, run the <code>diagnostic</code> executable look at plots adjust the step scale then run again fit and the process repeats. Each time you should look at autocorrelations, traces, etc. (see discussion above). Another important trick is not to run full fit. Instead of running 10M chain, you might run 200k. Number of steps depends on number of parameters and <em>Lag(n = ?)</em> you are interested in. <br  />
</p>
<p>There are a few things you should be aware of when tunning:</p><ul>
<li>Parameters with a broad range may have a higher step scale, while those with a narrow should have smaller ones to reduce the probability of going out of bounds.</li>
<li>Highly correlated should have a similiar step-scale, for edge cases like ~100% step scale should be identical!</li>
<li>Autocorelations should drop below 0.2 for <em>Lag(n = 10000)</em>. If it drops immediately then the step scale is too big.</li>
<li>Study trace, if is converging, exploring phase space fast enough. Exploring too fast is wrong.</li>
<li>Study acceptance probability. If every step is accepted then the scale is too small, while if barely any step is getting accepted you might consider decreasing the step scale.</li>
<li>Doing LLH scan and assigning a step scale based on such a result is also a good idea.</li>
</ul>
<p>The last point is that data fit may require a different tuning than the Asimov fit. Still, if you tune for Asimov it should be easy to re-tune for a data fit.</p>
<h3><a class="anchor" id="autotoc_md117"></a>
Manually Tuning Individual Step Scales in MaCh3</h3>
<p>Currently MaCh3 configures systematics in two ways. The first is simply through YAML configs which are used for cross-section systematics. Changing the step scale of parameter in a YAML config is simply a case of modifying the "StepScale" option for the parameter in the YAML file.</p>
<p>Some systematics, for example oscillation parameters, still use an <code>XML-&gt;ROOT</code> pipeline. Here the systematics are initially defined in an XML file first, for example in DUNE-MaCh3 they are located <a href="https://github.com/DUNE/MaCh3_DUNE/blob/main/utils/oscMatrixMaker/osc_covariance_DUNE_PDG2021_v1.xml">here</a>. Individual parameter step scales can then be modified through the <code>stepscale</code> option in the XML (although this may vary between systematics as it's a legacy system!). Finally, these can then be converted into a ROOT file with a suitable script, in the DUNE example this is located <a href="https://github.com/DUNE/MaCh3_DUNE/blob/main/utils/oscMatrixMaker/makeOscMatrix.py">here</a>. <br  />
</p>
<h2><a class="anchor" id="autotoc_md118"></a>
Adaptive MCMC</h2>
<p>Hopefully by this point you've realised that step size tuning is</p><ol type="1">
<li>Hard</li>
<li>Tedious</li>
</ol>
<p>Thankfully we can automate it! It turns out that, provided you Markov chain satisfies the Markov chain central limit theorem [2] it's optimal to propose steps from the posterior covariance matrix (multiplied by a scale factor).</p>
<p>The config then has the following options which let you tune this </p><div class="fragment"><div class="line">AdaptionOptions:</div>
<div class="line">  Settings:</div>
<div class="line">    StartThrow:      # [int] At which step do we start throwing from our new matrix?</div>
<div class="line">    StartUpdate:     # [int] At which step do we start adding steps to the covariance matrix?</div>
<div class="line">    EndUpdate:       # [int] At which step do we stop adding steps + fix the covariance matrix?</div>
<div class="line">    UpdateStep:      # [int] How often do we want to update i.e. change matrix we&#39;re throwing from?</div>
<div class="line">    SaveNIterations: # [int] How often do we want to save this to file</div>
<div class="line">    OutputFileName:  # [str] Name of the file containing the matrix</div>
<div class="line"> </div>
<div class="line">  Covariance:</div>
<div class="line">    xsec_cov: # Name of covariance matrix</div>
<div class="line">      DoAdaption:   # [bool] Adapt this parameter</div>
<div class="line">      MatrixBlocks: # [list[list[int]]] Split the matrix into blocks. Form of this is [[block start, block end]]. Note you can nest this like [[start, end, start, end]] to define a single block over multiple bits of the matrix</div>
<div class="line"> </div>
<div class="line">      # Robbins-Monro Settings</div>
<div class="line">      UseRobbinsMonro: # [bool] Do we you want to use Robbins-Monro to adapt matrix-scale </div>
<div class="line">      TargetAcceptance: 0.234 # Target acceptance rate</div>
<div class="line">      TotalRobbinsMonroRestarts: 5 # How many times do we restart the Robbins-Monro count</div>
<div class="line">      AcceptanceRateBatchSize: 5000 # After how many steps we restart the Robbins-Monro count</div>
<div class="line"> </div>
<div class="line">      # External stuff </div>
<div class="line">      UseExternalMatrix:      # [bool] Use a matrix from a file </div>
<div class="line">      ExternalMatrixFileName: # [str] Name of file containing matrix</div>
<div class="line">      ExternalMatrixName:     # [str] Name of matrix in file</div>
<div class="line">      ExternalMeansName:      # [str] Name of vector containing means, useful if you want to continue adapting from a previous chain</div>
</div><!-- fragment --><p> Adaptive step size tuning is still a little bit fiddly but works well if you have "Gaussian-ish" parameters [for example cross-section!]. Generally I'd recommend updating every few 1000 steps and stop updating after around 1,000,000 steps. <br  />
</p>
<p>For more info on adaptive MCMC please see <a href="https://github.com/mach3-software/MaCh3/wiki/16.-Adaptive-MCMC">section 16</a> in the wiki!</p>
<h1><a class="anchor" id="autotoc_md119"></a>
References &lt;br /&gt;</h1>
<p>[1] Kamil Skwarczynski PhD thesis <br  />
 [2] <a href="https://asp-eurasipjournals.springeropen.com/track/pdf/10.1186/s13634-020-00675-6.pdf">https://asp-eurasipjournals.springeropen.com/track/pdf/10.1186/s13634-020-00675-6.pdf</a> <br  />
</p>
<p>If you have complaints blame: Kamil Skwarczynski </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- Footer for MaCh3 Doxygen documentation -->
<footer class="mach3-footer" style="text-align: center;">
    <div style="margin-bottom: 15px;">
        <span style="font-weight: bold;">The MaCh3 Collaboration</span>
    </div>
    <!-- Dropdown to jump between doc versions -->
    <div style="margin-bottom: 10px;">
        <span>Select Software Version: </span>
        <select id="versionSelector" onchange="window.location.href=this.value" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="">-- Select --</option>
            <option value="https://mach3-software.github.io/MaCh3/">develop</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.4.0/index.html">v2.4.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.3.0/index.html">v2.3.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.2.0/index.html">v2.2.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.1.0/index.html">v2.1.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.0.0/index.html">v2.0.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.5.0/index.html">v1.5.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.4.0/index.html">v1.4.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.3.0/index.html">v1.3.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.2.0/index.html">v1.2.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.1.0/index.html">v1.1.0</option>
        </select>
    </div>
    <!-- Footer info about doxygen -->
    <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
        Documentation generated with
        <a href="https://www.doxygen.nl/" target="_blank" style="color: #666;">Doxygen</a>
        <span id="doxygenVersion"></span>
    </div>
    <!-- Now grab doxygen version from metadata -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const meta = document.querySelector('meta[name="generator"]');
        if (meta) {
            const version = meta.getAttribute("content").replace("Doxygen ", "");
            document.getElementById("doxygenVersion").textContent = " " + version;
        }
    });
    </script>
</footer>
