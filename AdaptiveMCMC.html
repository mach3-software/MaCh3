<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MaCh3: Adaptive MCMC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="MaCh3.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="mach3logo_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MaCh3
   &#160;<span id="projectnumber">2.4.2</span>
   </div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Adaptive MCMC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_Doc_User_Guide_16__Adaptive_MCMC"></a> </p>
<h1><a class="anchor" id="autotoc_md212"></a>
Overview</h1>
<p>Manually tuning MCMC is</p><ol type="1">
<li>Tedious</li>
<li>Hard</li>
</ol>
<p>Thankfully, we can automate this process! Adaptive MCMC (AMCMC) "learns" the optimal step size required to efficiently explore the space. In the case of a Gaussian proposal function target a roughly Gaussian parameter this turns out to be the covariance of the posterior multiplied by a constant scaling factor of $2.38^{2}/n_{pars}$. Since we can't know the covariance of the posterior before running a fit, we instead need to use the covariance of the chain we're currently running. We can then update our proposal function every few steps and hope this converges to the "true" posterior covariance.</p>
<h1><a class="anchor" id="autotoc_md213"></a>
Robbins-Monro Adaption</h1>
<p>In many spaces $2.38^{2}/n_{pars}$ is not actually the optimal scaling factor. Instead we can use a stochastic process called Robbins-Monro to increase/decrease this scale dynamically and get the chain to have a particular acceptance rate instead. Typically in MCMC this "optimal" rate is 23.4% (...in some sense) so we target this! In testing this has been shown to provide a 25%-300% improvement in efficiency (integrated auto-correlation) over regular adaptive MCMC with a fixed scale</p>
<h1><a class="anchor" id="autotoc_md214"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="autotoc_md215"></a>
HELP! My posteriors are miles away where I expect them to be!!!!</h2>
<p>A few easy checks first</p><ol type="1">
<li>Are your traces looking sensible?</li>
<li>Are your autocorrelations looking sensible?</li>
</ol>
<p>If it looks like the step sizes are WAY too big, you might have a multi-modal parameter involved (usually $\Delta m^{2}_{32}$). If that's the case, simply run a fit with all jumps switched off and then use that matrix as your proposal for all future chains.</p>
<p>If you have really good traces but bad auto-correlations, it might simply be the case that the adaptive process hasn't finished. A tell tale sign of this is the LogL vs step plot "jumping" to a different LLH value far from your current one when you finish updating the adaptive process. Typically this happens when you're updating a large (&gt;300 parameter) matrix with lots of correlations involved. Simply keep running the adaptive process for a few million more steps and waiting until there is a smooth transition between LLH and in the adaptive vs non-adaptive phases.</p>
<h2><a class="anchor" id="autotoc_md216"></a>
When does it Work?</h2>
<p>Adaptive MCMC works really well when all your parameters are Gaussian! This is typically the case for ND-only fits and most cross-section/flux parameters. As a rule of thumb it's best to start throwing from your covariance matrix about 1000 - 10,000 steps into running your fit. You can see the effects of changing the adaption starting step as well as how well tuned the initial step sizes here:</p>
<p><img src="https://github.com/user-attachments/assets/fd968ef5-f6e6-4a5d-bdcb-0cbe31beb39c" alt="image" class="inline"/></p>
<p><em>MCMC traces for chains with manual tuning (top), adaption applied from the first step (middle) and adaption applied from step 10,000. The chain with adaption from 10,000 shows the best fit with the lowest auto-correlation and a trace that rapidly improves before stabilising.</em></p>
<p>In order to ensure a "valid" fit, adaption should be stopped at some point! You can pick this either totally arbitrarily or by looking the MCMC trace. If it seems like the trace has stopped improving for ~100,000 steps or so then you're safe to assume the throw matrix has more or less converged and you can run the fit with it switched off.</p>
<h2><a class="anchor" id="autotoc_md217"></a>
How Do I Know It's Worked?</h2>
<p>As with all MCMC, the first step is to check your traces and auto-correlations. For AMCMC you expect the trace to get increasingly good as the chain goes on! Auto-correlations should be checked for a chain post-adaption since checking this with adapting steps can lead to some false-positive results simply because the chain is not ergodic. Additionally, for long Asimov chains, one can look at the posteriors and check that they seem sensible and converge to the correct values.</p>
<h2><a class="anchor" id="autotoc_md218"></a>
When Does This Fail?</h2>
<p>So far it seems that AMCMC fails for multi-modal and cyclical parameters i.e. oscillations (and anything correlated with them like detector parameters). This can result in chains that converge to entirely incorrect results as in the following figure.</p>
<p><img src="https://github.com/user-attachments/assets/27663413-7b4f-499e-b76a-f76e1aa01ac4" alt="image" class="inline"/></p>
<p><em>MCMC fit with adaption switched off for all parameters (blue), non-oscillation parameters (green) and all parameters (red). One can see that they converge to totally different values.</em></p>
<p>Adaptive MCMC can also run into problems with highly correlated parameters. This can be partially avoided by defining the highly correlated space as a separate "block". This separates your throw matrix into several independent block matrices with the correlated parts being separate to the less correlated parts. One example of this is with cross-section and flux parameters in T2K.</p>
<h2><a class="anchor" id="autotoc_md219"></a>
Additional Reading</h2>
<p>For more information on adaptive MCMC in MaCh3: <a href="https://etheses.whiterose.ac.uk/id/eprint/35901/">https://etheses.whiterose.ac.uk/id/eprint/35901/</a></p>
<p>For more information about adaptive MCMC in general: <a href="http://www.probability.ca/jeff/ftpdir/adaptex.pdf">http://www.probability.ca/jeff/ftpdir/adaptex.pdf</a></p>
<p>For more info on Robbins-Monro in MCMC: <a href="https://arxiv.org/abs/1006.3690">https://arxiv.org/abs/1006.3690</a></p>
<p>Useful Video Lecture: <a href="https://www.youtube.com/watch?v=DwE2-YMQR5Y">https://www.youtube.com/watch?v=DwE2-YMQR5Y</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- Footer for MaCh3 Doxygen documentation -->
<footer class="mach3-footer" style="text-align: center;">
    <div style="margin-bottom: 15px;">
        <span style="font-weight: bold;">The MaCh3 Collaboration</span>
    </div>
    <!-- Dropdown to jump between doc versions -->
    <div style="margin-bottom: 10px;">
        <span>Select Software Version: </span>
        <select id="versionSelector" onchange="window.location.href=this.value" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="">-- Select --</option>
            <option value="https://mach3-software.github.io/MaCh3/">develop</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.4.0/index.html">v2.4.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.3.0/index.html">v2.3.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.2.0/index.html">v2.2.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.1.0/index.html">v2.1.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.0.0/index.html">v2.0.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.5.0/index.html">v1.5.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.4.0/index.html">v1.4.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.3.0/index.html">v1.3.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.2.0/index.html">v1.2.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.1.0/index.html">v1.1.0</option>
        </select>
    </div>
    <!-- Footer info about doxygen -->
    <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
        Documentation generated with
        <a href="https://www.doxygen.nl/" target="_blank" style="color: #666;">Doxygen</a>
        <span id="doxygenVersion"></span>
    </div>
    <!-- Now grab doxygen version from metadata -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const meta = document.querySelector('meta[name="generator"]');
        if (meta) {
            const version = meta.getAttribute("content").replace("Doxygen ", "");
            document.getElementById("doxygenVersion").textContent = " " + version;
        }
    });
    </script>
</footer>
