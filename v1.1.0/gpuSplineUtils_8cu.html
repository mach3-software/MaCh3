<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MaCh3: /hosthome/v1.1.0/splines/gpuSplineUtils.cu File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="mach3logo_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MaCh3
   &#160;<span id="projectnumber">1.1.0</span>
   </div>
   <div id="projectbrief">Reference Guide</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_abce92e5f6d3eeff39dff8d05ee3c623.html">hosthome</a></li><li class="navelem"><a class="el" href="dir_4bbee8f31ba4a4a9da6009df3a2734de.html">v1.1.0</a></li><li class="navelem"><a class="el" href="dir_63fa6b7e89126aed1a2aaadd5115a8c4.html">splines</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">gpuSplineUtils.cu File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="gpuUtils_8cuh_source.html">manager/gpuUtils.cuh</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="SplineCommon_8h_source.html">splines/SplineCommon.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for gpuSplineUtils.cu:</div>
<div class="dyncontent">
<div class="center"><img src="gpuSplineUtils_8cu__incl.png" border="0" usemap="#a_2hosthome_2v1_81_80_2splines_2gpuSplineUtils_8cu" alt=""/></div>
<map name="a_2hosthome_2v1_81_80_2splines_2gpuSplineUtils_8cu" id="a_2hosthome_2v1_81_80_2splines_2gpuSplineUtils_8cu">
<area shape="rect" title=" " alt="" coords="127,5,295,47"/>
<area shape="rect" href="gpuUtils_8cuh.html" title=" " alt="" coords="45,95,195,121"/>
<area shape="rect" href="SplineCommon_8h.html" title=" " alt="" coords="219,95,386,121"/>
<area shape="rect" title=" " alt="" coords="5,169,67,196"/>
<area shape="rect" title=" " alt="" coords="91,169,149,196"/>
<area shape="rect" title=" " alt="" coords="173,169,283,196"/>
</map>
</div>
</div>
<p><a href="gpuSplineUtils_8cu_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a466f32a4912da866d5014fd8cdbd06a4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>&#160;&#160;&#160;160</td></tr>
<tr class="separator:a466f32a4912da866d5014fd8cdbd06a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a1d9ccd919e57eb2e2939932bca23e205"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a1d9ccd919e57eb2e2939932bca23e205">InitGPU_SepMany</a> (float **gpu_x_array, float **gpu_many_array, float **gpu_weights, short int **gpu_paramNo_arr, unsigned int **gpu_nKnots_arr, float **cpu_total_weights, float **gpu_total_weights, int n_events, unsigned int **gpu_nParamPerEvent, unsigned int sizeof_array, unsigned int n_splines, int Eve_size)</td></tr>
<tr class="memdesc:a1d9ccd919e57eb2e2939932bca23e205"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialiser when using the x array and combined y,b,c,d array.  <a href="gpuSplineUtils_8cu.html#a1d9ccd919e57eb2e2939932bca23e205">More...</a><br /></td></tr>
<tr class="separator:a1d9ccd919e57eb2e2939932bca23e205"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a477d39804560c8f066b91a5f79fbfa0b"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a477d39804560c8f066b91a5f79fbfa0b">InitGPU_TF1</a> (float **gpu_coeffs, short int **gpu_paramNo_arr, short int **gpu_nPoints_arr, float **gpu_weights, float **cpu_total_weights, float **gpu_total_weights, int n_events, unsigned int **gpu_nParamPerEvent, unsigned int n_splines)</td></tr>
<tr class="memdesc:a477d39804560c8f066b91a5f79fbfa0b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialiser when using the x array and combined y,b,c,d array.  <a href="gpuSplineUtils_8cu.html#a477d39804560c8f066b91a5f79fbfa0b">More...</a><br /></td></tr>
<tr class="separator:a477d39804560c8f066b91a5f79fbfa0b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a619be845847738447535c5628ff72c4c"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a619be845847738447535c5628ff72c4c">InitGPU_Segments</a> (short int **segment)</td></tr>
<tr class="memdesc:a619be845847738447535c5628ff72c4c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocate memory for spline segments.  <a href="gpuSplineUtils_8cu.html#a619be845847738447535c5628ff72c4c">More...</a><br /></td></tr>
<tr class="separator:a619be845847738447535c5628ff72c4c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc3b24da038d746b5ccfcee61ba26b90"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#acc3b24da038d746b5ccfcee61ba26b90">InitGPU_Vals</a> (float **vals)</td></tr>
<tr class="separator:acc3b24da038d746b5ccfcee61ba26b90"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1b13a9af140a7b044a220055f2c68c3a"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a1b13a9af140a7b044a220055f2c68c3a">CopyToGPU_SepMany</a> (short int *gpu_paramNo_arr, unsigned int *gpu_nKnots_arr, float *gpu_x_array, float *gpu_many_array, std::vector&lt; short int &gt; paramNo_arr, std::vector&lt; unsigned int &gt; nKnots_arr, std::vector&lt; float &gt; cpu_x_array, std::vector&lt; float &gt; cpu_many_array, int n_events, std::vector&lt; unsigned int &gt; cpu_nParamPerEvent, unsigned int *gpu_nParamPerEvent, int n_params, unsigned int n_splines, short int spline_size, unsigned int sizeof_array)</td></tr>
<tr class="memdesc:a1b13a9af140a7b044a220055f2c68c3a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Copy to GPU for x array and separate ybcd array.  <a href="gpuSplineUtils_8cu.html#a1b13a9af140a7b044a220055f2c68c3a">More...</a><br /></td></tr>
<tr class="separator:a1b13a9af140a7b044a220055f2c68c3a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a44452c7b7fdb280a47e1a74f7b982816"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a44452c7b7fdb280a47e1a74f7b982816">CopyToGPU_TF1</a> (float *gpu_coeffs, short int *gpu_paramNo_arr, short int *gpu_nPoints_arr, std::vector&lt; float &gt; cpu_coeffs, std::vector&lt; short int &gt; paramNo_arr, std::vector&lt; short int &gt; nPoints_arr, int n_events, std::vector&lt; unsigned int &gt; cpu_nParamPerEvent, unsigned int *gpu_nParamPerEvent, int n_params, unsigned int n_splines, short int _max_knots)</td></tr>
<tr class="memdesc:a44452c7b7fdb280a47e1a74f7b982816"><td class="mdescLeft">&#160;</td><td class="mdescRight">Copy to GPU for x array and separate ybcd array.  <a href="gpuSplineUtils_8cu.html#a44452c7b7fdb280a47e1a74f7b982816">More...</a><br /></td></tr>
<tr class="separator:a44452c7b7fdb280a47e1a74f7b982816"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af750039eb492fc0806731126d62d2116"><td class="memItemLeft" align="right" valign="top">__global__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#af750039eb492fc0806731126d62d2116">EvalOnGPU_SepMany</a> (const short int *__restrict__ gpu_paramNo_arr, const unsigned int *__restrict__ gpu_nKnots_arr, const float *__restrict__ gpu_coeff_many, float *gpu_weights, const cudaTextureObject_t __restrict__ <a class="el" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a>)</td></tr>
<tr class="memdesc:af750039eb492fc0806731126d62d2116"><td class="mdescLeft">&#160;</td><td class="mdescRight">Evaluate the spline on the GPU Using one {y,b,c,d} array and one {x} array Should be most efficient at cache hitting and memory coalescence But using spline segments rather than the parameter value: avoids doing binary search on GPU.  <a href="gpuSplineUtils_8cu.html#af750039eb492fc0806731126d62d2116">More...</a><br /></td></tr>
<tr class="separator:af750039eb492fc0806731126d62d2116"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a552ab62a9156d3608c1cf6bd6986f867"><td class="memItemLeft" align="right" valign="top">__global__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a552ab62a9156d3608c1cf6bd6986f867">EvalOnGPU_TF1</a> (const float *__restrict__ gpu_coeffs, const short int *__restrict__ gpu_paramNo_arr, const short int *__restrict__ gpu_nPoints_arr, float *gpu_weights)</td></tr>
<tr class="memdesc:a552ab62a9156d3608c1cf6bd6986f867"><td class="mdescLeft">&#160;</td><td class="mdescRight">Evaluate the TF1 on the GPU Using 5th order polynomial.  <a href="gpuSplineUtils_8cu.html#a552ab62a9156d3608c1cf6bd6986f867">More...</a><br /></td></tr>
<tr class="separator:a552ab62a9156d3608c1cf6bd6986f867"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae09038165064bd9d6a8acd2d2da21796"><td class="memItemLeft" align="right" valign="top">__global__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#ae09038165064bd9d6a8acd2d2da21796">EvalOnGPU_TotWeight</a> (const float *__restrict__ gpu_weights, float *gpu_total_weights, const cudaTextureObject_t __restrict__ <a class="el" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>)</td></tr>
<tr class="memdesc:ae09038165064bd9d6a8acd2d2da21796"><td class="mdescLeft">&#160;</td><td class="mdescRight">KS: Evaluate the total spline event weight on the GPU, as in most cases GPU is faster, even more this significant reduce memory transfer from GPU to CPU.  <a href="gpuSplineUtils_8cu.html#ae09038165064bd9d6a8acd2d2da21796">More...</a><br /></td></tr>
<tr class="separator:ae09038165064bd9d6a8acd2d2da21796"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed019a3225e3b5495de177e61dc3254a"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#aed019a3225e3b5495de177e61dc3254a">RunGPU_SepMany</a> (const short int *gpu_paramNo_arr, const unsigned int *gpu_nKnots_arr, const float *gpu_coeff_many, float *gpu_weights, float *gpu_total_weights, float *cpu_total_weights, float *vals, short int *segment, const unsigned int h_n_splines)</td></tr>
<tr class="memdesc:aed019a3225e3b5495de177e61dc3254a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run the GPU code for the separate many arrays. As in separate {x}, {y,b,c,d} arrays Pass the segment and the parameter values (binary search already performed in samplePDFND::FindSplineSegment()  <a href="gpuSplineUtils_8cu.html#aed019a3225e3b5495de177e61dc3254a">More...</a><br /></td></tr>
<tr class="separator:aed019a3225e3b5495de177e61dc3254a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7036492f5c28b1a79444ef9ed1def495"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a7036492f5c28b1a79444ef9ed1def495">RunGPU_TF1</a> (const float *gpu_coeffs, const short int *gpu_paramNo_arr, const short int *gpu_nPoints_arr, float *gpu_weights, float *gpu_total_weights, float *cpu_total_weights, float *vals, const unsigned int h_n_splines)</td></tr>
<tr class="memdesc:a7036492f5c28b1a79444ef9ed1def495"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run the GPU code for the TF1.  <a href="gpuSplineUtils_8cu.html#a7036492f5c28b1a79444ef9ed1def495">More...</a><br /></td></tr>
<tr class="separator:a7036492f5c28b1a79444ef9ed1def495"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a953e5c5aecebd908f5d8c6ad64de482c"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a953e5c5aecebd908f5d8c6ad64de482c">SynchroniseSplines</a> ()</td></tr>
<tr class="memdesc:a953e5c5aecebd908f5d8c6ad64de482c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Make sure all Cuda threads finished execution.  <a href="gpuSplineUtils_8cu.html#a953e5c5aecebd908f5d8c6ad64de482c">More...</a><br /></td></tr>
<tr class="separator:a953e5c5aecebd908f5d8c6ad64de482c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac999450ca921ec45990ab785e1d0f179"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#ac999450ca921ec45990ab785e1d0f179">CleanupGPU_SepMany</a> (short int *gpu_paramNo_arr, unsigned int *gpu_nKnots_arr, float *gpu_x_array, float *gpu_many_array, float *gpu_total_weights, unsigned int *gpu_nParamPerEvent, float *cpu_total_weights, float *gpu_weights)</td></tr>
<tr class="memdesc:ac999450ca921ec45990ab785e1d0f179"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clean up the {x},{ybcd} arrays.  <a href="gpuSplineUtils_8cu.html#ac999450ca921ec45990ab785e1d0f179">More...</a><br /></td></tr>
<tr class="separator:ac999450ca921ec45990ab785e1d0f179"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae17e68e55fea24bcac1dde0ef11fe299"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#ae17e68e55fea24bcac1dde0ef11fe299">CleanupGPU_Segments</a> (short int *segment, float *vals)</td></tr>
<tr class="memdesc:ae17e68e55fea24bcac1dde0ef11fe299"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clean up pinned variables at CPU.  <a href="gpuSplineUtils_8cu.html#ae17e68e55fea24bcac1dde0ef11fe299">More...</a><br /></td></tr>
<tr class="separator:ae17e68e55fea24bcac1dde0ef11fe299"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aff9cee00fa6bc134407bde3c7b1b5962"><td class="memItemLeft" align="right" valign="top">__host__ void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#aff9cee00fa6bc134407bde3c7b1b5962">CleanupGPU_TF1</a> (float *gpu_coeffs, short int *gpu_paramNo_arr, short int *gpu_nPoints_arr, float *gpu_total_weights, float *cpu_total_weights, float *gpu_weights)</td></tr>
<tr class="memdesc:aff9cee00fa6bc134407bde3c7b1b5962"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clean up the TF1 arrays.  <a href="gpuSplineUtils_8cu.html#aff9cee00fa6bc134407bde3c7b1b5962">More...</a><br /></td></tr>
<tr class="separator:aff9cee00fa6bc134407bde3c7b1b5962"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a8df652f27dcffc6b349298601ed790ea"><td class="memItemLeft" align="right" valign="top">__device__ __constant__ unsigned int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a></td></tr>
<tr class="memdesc:a8df652f27dcffc6b349298601ed790ea"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of splines living on GPU.  <a href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">More...</a><br /></td></tr>
<tr class="separator:a8df652f27dcffc6b349298601ed790ea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae11082fcc44d3cf2e38cb74043fd7835"><td class="memItemLeft" align="right" valign="top">__device__ __constant__ short int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a></td></tr>
<tr class="memdesc:ae11082fcc44d3cf2e38cb74043fd7835"><td class="mdescLeft">&#160;</td><td class="mdescRight">Size of splines living on GPU.  <a href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">More...</a><br /></td></tr>
<tr class="separator:ae11082fcc44d3cf2e38cb74043fd7835"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad333bfa4035ada9207fc1df19272c4e2"><td class="memItemLeft" align="right" valign="top">__device__ __constant__ int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#ad333bfa4035ada9207fc1df19272c4e2">d_n_events</a></td></tr>
<tr class="memdesc:ad333bfa4035ada9207fc1df19272c4e2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of events living on GPU.  <a href="gpuSplineUtils_8cu.html#ad333bfa4035ada9207fc1df19272c4e2">More...</a><br /></td></tr>
<tr class="separator:ad333bfa4035ada9207fc1df19272c4e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af2c36e71fccde8cfdfd4efcf469d6204"><td class="memItemLeft" align="right" valign="top">__device__ __constant__ float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a> [160]</td></tr>
<tr class="memdesc:af2c36e71fccde8cfdfd4efcf469d6204"><td class="mdescLeft">&#160;</td><td class="mdescRight">CW: Constant memory needs to be hard-coded on compile time. Could make this texture memory instead, but don't care enough right now...  <a href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">More...</a><br /></td></tr>
<tr class="separator:af2c36e71fccde8cfdfd4efcf469d6204"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a76574fafa48b0cba6adea505b0517004"><td class="memItemLeft" align="right" valign="top">__device__ __constant__ short int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a76574fafa48b0cba6adea505b0517004">segment_gpu</a> [160]</td></tr>
<tr class="separator:a76574fafa48b0cba6adea505b0517004"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a43574e01dd0d1f01bd8dd261ab5521e8"><td class="memItemLeft" align="right" valign="top">static short int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a> = -1</td></tr>
<tr class="memdesc:a43574e01dd0d1f01bd8dd261ab5521e8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of splines living on CPU.  <a href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">More...</a><br /></td></tr>
<tr class="separator:a43574e01dd0d1f01bd8dd261ab5521e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a374cb9eb9a8a9a79fa09a0b916acf166"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a> = -1</td></tr>
<tr class="memdesc:a374cb9eb9a8a9a79fa09a0b916acf166"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of params living on CPU.  <a href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">More...</a><br /></td></tr>
<tr class="separator:a374cb9eb9a8a9a79fa09a0b916acf166"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abc47d2cce54457c72a996222ec0a9ce4"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a> = -1</td></tr>
<tr class="memdesc:abc47d2cce54457c72a996222ec0a9ce4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of events living on CPU.  <a href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">More...</a><br /></td></tr>
<tr class="separator:abc47d2cce54457c72a996222ec0a9ce4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a20b9e0707c409d990103a531cee49ce0"><td class="memItemLeft" align="right" valign="top">cudaTextureObject_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a> = 0</td></tr>
<tr class="memdesc:a20b9e0707c409d990103a531cee49ce0"><td class="mdescLeft">&#160;</td><td class="mdescRight">KS: Textures are L1 cache variables which are well optimised for fetching. Make texture only for variables you often access but rarely overwrite. There are limits on texture memory so don't use huge arrays.  <a href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">More...</a><br /></td></tr>
<tr class="separator:a20b9e0707c409d990103a531cee49ce0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af7cc79856fc0663cb8fd2a9480cccfad"><td class="memItemLeft" align="right" valign="top">cudaTextureObject_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a> = 0</td></tr>
<tr class="memdesc:af7cc79856fc0663cb8fd2a9480cccfad"><td class="mdescLeft">&#160;</td><td class="mdescRight">KS: Map keeping track how many parameters applies to each event, we keep two numbers here {number of splines per event, index where splines start for a given event}.  <a href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">More...</a><br /></td></tr>
<tr class="separator:af7cc79856fc0663cb8fd2a9480cccfad"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a466f32a4912da866d5014fd8cdbd06a4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a466f32a4912da866d5014fd8cdbd06a4">&#9670;&nbsp;</a></span>_N_SPLINES_</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _N_SPLINES_&#160;&#160;&#160;160</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Hard code the number of splines Not entirely necessary: only used for val_gpu and segment_gpu being device constants. Could move them to not being device constants EM: for OA2022: </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00020">20</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ae17e68e55fea24bcac1dde0ef11fe299"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae17e68e55fea24bcac1dde0ef11fe299">&#9670;&nbsp;</a></span>CleanupGPU_Segments()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void CleanupGPU_Segments </td>
          <td>(</td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>segment</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>vals</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clean up pinned variables at CPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00843">843</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                                                                   {</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">// *******************************************</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    cudaFreeHost(segment);</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    cudaFreeHost(vals);</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160; </div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    segment = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    vals = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ac999450ca921ec45990ab785e1d0f179"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac999450ca921ec45990ab785e1d0f179">&#9670;&nbsp;</a></span>CleanupGPU_SepMany()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void CleanupGPU_SepMany </td>
          <td>(</td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&#160;</td>
          <td class="paramname"><em>gpu_nKnots_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_x_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_many_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&#160;</td>
          <td class="paramname"><em>gpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>cpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_weights</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clean up the {x},{ybcd} arrays. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00807">807</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                        {</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="comment">// *********************************</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  cudaFree(gpu_paramNo_arr);</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  cudaFree(gpu_nKnots_arr);</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160; </div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  <span class="comment">// free the coefficient arrays</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  cudaDestroyTextureObject(<a class="code" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a>);</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  cudaFree(gpu_x_array);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;  cudaFree(gpu_many_array);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160; </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <span class="comment">// free weights on the gpu</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  cudaFree(gpu_weights);</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  cudaFree(gpu_total_weights);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="comment">//KS: Before removing variable let&#39;s destroy texture</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  cudaDestroyTextureObject(<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>);</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  cudaFree(gpu_nParamPerEvent);</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  cudaFreeHost(cpu_total_weights);</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  cpu_total_weights = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;}</div>
<div class="ttc" id="agpuSplineUtils_8cu_html_a20b9e0707c409d990103a531cee49ce0"><div class="ttname"><a href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a></div><div class="ttdeci">cudaTextureObject_t text_coeff_x</div><div class="ttdoc">KS: Textures are L1 cache variables which are well optimised for fetching. Make texture only for vari...</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00099">gpuSplineUtils.cu:99</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_af7cc79856fc0663cb8fd2a9480cccfad"><div class="ttname"><a href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a></div><div class="ttdeci">cudaTextureObject_t text_nParamPerEvent</div><div class="ttdoc">KS: Map keeping track how many parameters applies to each event, we keep two numbers here {number of ...</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00102">gpuSplineUtils.cu:102</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aff9cee00fa6bc134407bde3c7b1b5962"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aff9cee00fa6bc134407bde3c7b1b5962">&#9670;&nbsp;</a></span>CleanupGPU_TF1()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void CleanupGPU_TF1 </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_coeffs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>gpu_nPoints_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>cpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_weights</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clean up the TF1 arrays. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00856">856</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                        {</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="comment">// *********************************</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  cudaFree(gpu_coeffs);</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  cudaFree(gpu_paramNo_arr);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  cudaFree(gpu_nPoints_arr);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  cudaFree(gpu_weights);</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  cudaFree(gpu_total_weights);</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  cudaFreeHost(cpu_total_weights);</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  </div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a1b13a9af140a7b044a220055f2c68c3a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1b13a9af140a7b044a220055f2c68c3a">&#9670;&nbsp;</a></span>CopyToGPU_SepMany()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void CopyToGPU_SepMany </td>
          <td>(</td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&#160;</td>
          <td class="paramname"><em>gpu_nKnots_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_x_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_many_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; short int &gt;&#160;</td>
          <td class="paramname"><em>paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; unsigned int &gt;&#160;</td>
          <td class="paramname"><em>nKnots_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; float &gt;&#160;</td>
          <td class="paramname"><em>cpu_x_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; float &gt;&#160;</td>
          <td class="paramname"><em>cpu_many_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n_events</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; unsigned int &gt;&#160;</td>
          <td class="paramname"><em>cpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&#160;</td>
          <td class="paramname"><em>gpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n_params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>n_splines</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&#160;</td>
          <td class="paramname"><em>spline_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>sizeof_array</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Copy to GPU for x array and separate ybcd array. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00256">256</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                                       {</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  <span class="keywordflow">if</span> (n_params != <a class="code" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>) {</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    printf(<span class="stringliteral">&quot;Number of splines not equal to %i, GPU code for event-by-event splines will fail\n&quot;</span>, <a class="code" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    printf(<span class="stringliteral">&quot;n_params = %i\n&quot;</span>, n_params);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    printf(<span class="stringliteral">&quot;%s : %i\n&quot;</span>, __FILE__, __LINE__);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    exit(-1);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  }</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="comment">// Write to the global statics (h_* denotes host stored variable)</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a> = n_params;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <a class="code" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a> = spline_size;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>    = n_events;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="comment">// Copy the constants</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="comment">// Total number of valid splines for all loaded events</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a>,   &amp;n_splines,   <span class="keyword">sizeof</span>(n_splines));</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="comment">// Total spline size per spline; i.e. just the number of points or knots in the spline</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>, &amp;<a class="code" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a>, <span class="keyword">sizeof</span>(<a class="code" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a>));</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="comment">// Number of events</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#ad333bfa4035ada9207fc1df19272c4e2">d_n_events</a>, &amp;<a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>, <span class="keyword">sizeof</span>(<a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>));</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  <span class="comment">// Copy the coefficient arrays to the GPU; this only happens once per entire Markov Chain so is OK to do multiple extensive memory copies</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  cudaMemcpy(gpu_many_array, cpu_many_array.data(), <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*sizeof_array*<a class="code" href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a>, cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  cudaMemcpy(gpu_x_array, cpu_x_array.data(), <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*spline_size*n_params, cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="comment">//KS: Bind our texture with the GPU variable</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="comment">//KS: Tried also moving gpu_many_array to texture memory it only worked with restricted number of MC runs, most likely hit texture memory limit :(</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keyword">struct </span>cudaResourceDesc resDesc_coeff_x;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  memset(&amp;resDesc_coeff_x, 0, <span class="keyword">sizeof</span>(resDesc_coeff_x));</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  resDesc_coeff_x.resType = cudaResourceTypeLinear;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  resDesc_coeff_x.res.linear.devPtr = gpu_x_array;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  resDesc_coeff_x.res.linear.desc = cudaCreateChannelDesc&lt;float&gt;();</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  resDesc_coeff_x.res.linear.sizeInBytes = <span class="keyword">sizeof</span>(float)*spline_size*n_params;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="comment">// Specify texture object parameters</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  <span class="keyword">struct </span>cudaTextureDesc texDesc_coeff_x;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  memset(&amp;texDesc_coeff_x, 0, <span class="keyword">sizeof</span>(texDesc_coeff_x));</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  texDesc_coeff_x.readMode = cudaReadModeElementType;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; </div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="comment">// Create texture object</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  cudaCreateTextureObject(&amp;<a class="code" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a>, &amp;resDesc_coeff_x, &amp;texDesc_coeff_x, NULL);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160; </div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="comment">// Also copy the parameter number for each spline onto the GPU; i.e. what spline parameter are we calculating right now</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  cudaMemcpy(gpu_paramNo_arr, paramNo_arr.data(), n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160; </div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  <span class="comment">// Also copy the knot map for each spline onto the GPU;</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  cudaMemcpy(gpu_nKnots_arr, nKnots_arr.data(), n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="preprocessor">  #ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  <span class="comment">//KS: Keep track how much splines each event has  </span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  cudaMemcpy(gpu_nParamPerEvent, cpu_nParamPerEvent.data(), 2*n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  </div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  <span class="comment">//KS: Bind our texture with the GPU variable</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="comment">// create a resource descriptor based on device pointers</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keyword">struct </span>cudaResourceDesc resDesc_nParamPerEvent;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  memset(&amp;resDesc_nParamPerEvent, 0, <span class="keyword">sizeof</span>(resDesc_nParamPerEvent));</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  resDesc_nParamPerEvent.resType = cudaResourceTypeLinear;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  resDesc_nParamPerEvent.res.linear.devPtr = gpu_nParamPerEvent;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  resDesc_nParamPerEvent.res.linear.desc = cudaCreateChannelDesc&lt;unsigned int&gt;();</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  resDesc_nParamPerEvent.res.linear.sizeInBytes = 2*n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160; </div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  <span class="comment">// Specify texture object parameters</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="keyword">struct </span>cudaTextureDesc texDesc_nParamPerEvent;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  memset(&amp;texDesc_nParamPerEvent, 0, <span class="keyword">sizeof</span>(texDesc_nParamPerEvent));</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  texDesc_nParamPerEvent.readMode = cudaReadModeElementType;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="comment">//Finally create texture object</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  cudaCreateTextureObject(&amp;<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>, &amp;resDesc_nParamPerEvent, &amp;texDesc_nParamPerEvent, NULL);</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;}</div>
<div class="ttc" id="aSplineCommon_8h_html_a283177311bade7400c6088e8fad71a1f"><div class="ttname"><a href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a></div><div class="ttdeci">#define _nCoeff_</div><div class="ttdoc">KS: We store coefficients {y,b,c,d} in one array one by one, this is only to define it once rather th...</div><div class="ttdef"><b>Definition:</b> <a href="SplineCommon_8h_source.html#l00008">SplineCommon.h:8</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_a374cb9eb9a8a9a79fa09a0b916acf166"><div class="ttname"><a href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a></div><div class="ttdeci">static int h_n_params</div><div class="ttdoc">Number of params living on CPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00089">gpuSplineUtils.cu:89</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_a43574e01dd0d1f01bd8dd261ab5521e8"><div class="ttname"><a href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a></div><div class="ttdeci">static short int h_spline_size</div><div class="ttdoc">Number of splines living on CPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00087">gpuSplineUtils.cu:87</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_a466f32a4912da866d5014fd8cdbd06a4"><div class="ttname"><a href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a></div><div class="ttdeci">#define _N_SPLINES_</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00020">gpuSplineUtils.cu:20</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_a8df652f27dcffc6b349298601ed790ea"><div class="ttname"><a href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a></div><div class="ttdeci">__device__ __constant__ unsigned int d_n_splines</div><div class="ttdoc">Number of splines living on GPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00074">gpuSplineUtils.cu:74</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_abc47d2cce54457c72a996222ec0a9ce4"><div class="ttname"><a href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a></div><div class="ttdeci">static int h_n_events</div><div class="ttdoc">Number of events living on CPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00092">gpuSplineUtils.cu:92</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_ad333bfa4035ada9207fc1df19272c4e2"><div class="ttname"><a href="gpuSplineUtils_8cu.html#ad333bfa4035ada9207fc1df19272c4e2">d_n_events</a></div><div class="ttdeci">__device__ __constant__ int d_n_events</div><div class="ttdoc">Number of events living on GPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00079">gpuSplineUtils.cu:79</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_ae11082fcc44d3cf2e38cb74043fd7835"><div class="ttname"><a href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a></div><div class="ttdeci">__device__ __constant__ short int d_spline_size</div><div class="ttdoc">Size of splines living on GPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00076">gpuSplineUtils.cu:76</a></div></div>
<div class="ttc" id="agpuUtils_8cuh_html_a0345e89c96b417069f1e64674cc77318"><div class="ttname"><a href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a></div><div class="ttdeci">#define CudaCheckError()</div><div class="ttdef"><b>Definition:</b> <a href="gpuUtils_8cuh_source.html#l00018">gpuUtils.cuh:18</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a44452c7b7fdb280a47e1a74f7b982816"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a44452c7b7fdb280a47e1a74f7b982816">&#9670;&nbsp;</a></span>CopyToGPU_TF1()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void CopyToGPU_TF1 </td>
          <td>(</td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_coeffs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>gpu_nPoints_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; float &gt;&#160;</td>
          <td class="paramname"><em>cpu_coeffs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; short int &gt;&#160;</td>
          <td class="paramname"><em>paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; short int &gt;&#160;</td>
          <td class="paramname"><em>nPoints_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n_events</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; unsigned int &gt;&#160;</td>
          <td class="paramname"><em>cpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&#160;</td>
          <td class="paramname"><em>gpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n_params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>n_splines</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&#160;</td>
          <td class="paramname"><em>_max_knots</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Copy to GPU for x array and separate ybcd array. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00362">362</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                                                  {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordflow">if</span> (n_params != <a class="code" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>) {</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    printf(<span class="stringliteral">&quot;Number of splines not equal to %i, GPU code for event-by-event splines will fail\n&quot;</span>, <a class="code" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    printf(<span class="stringliteral">&quot;n_params = %i\n&quot;</span>, n_params);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    printf(<span class="stringliteral">&quot;%s : %i\n&quot;</span>, __FILE__, __LINE__);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    exit(-1);</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  }</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160; </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="comment">// Write to the global statics (h_* denotes host stored variable)</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a> = n_params;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <a class="code" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a> = _max_knots;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>    = n_events;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="comment">// Copy the constants</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="comment">// Total number of valid splines for all loaded events</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a>,   &amp;n_splines,   <span class="keyword">sizeof</span>(n_splines));</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="comment">// Total spline size per spline; i.e. just the number of points or knots in the spline</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>, &amp;<a class="code" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a>, <span class="keyword">sizeof</span>(<a class="code" href="gpuSplineUtils_8cu.html#a43574e01dd0d1f01bd8dd261ab5521e8">h_spline_size</a>));</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160; </div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="comment">// Number of events</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#ad333bfa4035ada9207fc1df19272c4e2">d_n_events</a>, &amp;<a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>, <span class="keyword">sizeof</span>(<a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>));</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  <span class="comment">// Move the coefficients</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  cudaMemcpy(gpu_coeffs, cpu_coeffs.data(), n_splines*5*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160; </div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="comment">// Also copy the parameter number for each spline onto the GPU; i.e. what spline parameter are we calculating right now</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  cudaMemcpy(gpu_paramNo_arr, paramNo_arr.data(), n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160; </div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  cudaMemcpy(gpu_nPoints_arr, nPoints_arr.data(), n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="preprocessor">  #ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="comment">//KS: Keep track how much splines each event has  </span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  cudaMemcpy(gpu_nParamPerEvent, cpu_nParamPerEvent.data(), 2*n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), cudaMemcpyHostToDevice);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160; </div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="comment">//KS: Bind our texture with the GPU variable</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  <span class="comment">// create a resource descriptor based on device pointers</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="keyword">struct </span>cudaResourceDesc resDesc_nParamPerEvent;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  memset(&amp;resDesc_nParamPerEvent, 0, <span class="keyword">sizeof</span>(resDesc_nParamPerEvent));</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  resDesc_nParamPerEvent.resType = cudaResourceTypeLinear;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  resDesc_nParamPerEvent.res.linear.devPtr = gpu_nParamPerEvent;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  resDesc_nParamPerEvent.res.linear.desc = cudaCreateChannelDesc&lt;float&gt;();</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  resDesc_nParamPerEvent.res.linear.sizeInBytes = 2*n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160; </div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="comment">// Specify texture object parameters</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keyword">struct </span>cudaTextureDesc texDesc_nParamPerEvent;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  memset(&amp;texDesc_nParamPerEvent, 0, <span class="keyword">sizeof</span>(texDesc_nParamPerEvent));</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  texDesc_nParamPerEvent.readMode = cudaReadModeElementType;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160; </div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="comment">//Lastly create texture object</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  cudaCreateTextureObject(&amp;<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>, &amp;resDesc_nParamPerEvent, &amp;texDesc_nParamPerEvent, NULL);</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af750039eb492fc0806731126d62d2116"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af750039eb492fc0806731126d62d2116">&#9670;&nbsp;</a></span>EvalOnGPU_SepMany()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__global__ void EvalOnGPU_SepMany </td>
          <td>(</td>
          <td class="paramtype">const short int *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned int *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_nKnots_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_coeff_many</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const cudaTextureObject_t __restrict__&#160;</td>
          <td class="paramname"><em>text_coeff_x</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Evaluate the spline on the GPU Using one {y,b,c,d} array and one {x} array Should be most efficient at cache hitting and memory coalescence But using spline segments rather than the parameter value: avoids doing binary search on GPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00454">454</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                                                         {</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">//*********************************************************</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160; </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="comment">// points per spline is the offset to skip in the index to move between splines</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> splineNum = (blockIdx.x * blockDim.x + threadIdx.x);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="comment">// Note, the new arrays are arranged as:</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="comment">//       gpu_paramNo_arr has length = spln_counter (keeps track of which parameter we&#39;re using on this thread)</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="comment">//       gpu_nKnots_arrhas length = spln_counter (keeps track where current spline starts)</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="comment">//       text_coeff_x has length = n_params * spline_size</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="comment">//       gpu_coeff_many has length = nKnots * 4</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="comment">//       ...</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="comment">//       gpu_weights has length = spln_counter * spline_size</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160; </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  <span class="comment">// this is the stopping condition!</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <span class="keywordflow">if</span> (splineNum &lt; <a class="code" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a>) {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="comment">// This is the segment we want for this parameter variation</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="comment">// for this particular splineNum; 0 = MACCQE, 1 = pFC, 2 = EBC, etc</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160; </div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="comment">//CW: Which Parameter we are accesing</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> Param = gpu_paramNo_arr[splineNum];</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="comment">//CW: Avoids doing costly binary search on GPU</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> segment = <a class="code" href="gpuSplineUtils_8cu.html#a76574fafa48b0cba6adea505b0517004">segment_gpu</a>[Param];</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160; </div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="comment">//KS: Segment for coeff_x is simply parameter*max knots + segment as each parmeters has the same spacing</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> segment_X = Param*<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>+segment;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160; </div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="comment">//KS: Find knot position in out monolitical structure</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> CurrentKnotPos = gpu_nKnots_arr[splineNum]*<a class="code" href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a>+segment*<a class="code" href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a>;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160; </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">// We&#39;ve read the segment straight from CPU and is saved in segment_gpu</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="comment">// polynomial parameters from the monolithic splineMonolith</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> fY = gpu_coeff_many[CurrentKnotPos];</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> fB = gpu_coeff_many[CurrentKnotPos+1];</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> fC = gpu_coeff_many[CurrentKnotPos+2];</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> fD = gpu_coeff_many[CurrentKnotPos+3];</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="comment">// The is the variation itself (needed to evaluate variation - stored spline point = dx)</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> dx = <a class="code" href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a>[Param] - tex1Dfetch&lt;float&gt;(<a class="code" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a>, segment_X);</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160; </div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">//CW: Wooow, let&#39;s use some fancy intrinsics and pull down the processing time by &lt;1% from normal multiplication! HURRAY</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    gpu_weights[splineNum] = fmaf(dx, fmaf(dx, fmaf(dx, fD, fC), fB), fY);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="comment">// Or for the more &quot;easy to read&quot; version:</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">//gpu_weights[splineNum] = (fY+dx*(fB+dx*(fC+dx*fD)));</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160; </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  printf(<span class="stringliteral">&quot;splineNum = %i/%i, paramNo = %i, variation = %f, segment = %i, fX = %f, fX+1 = %f, dx = %f, d_n_splines = %i, d_spline_size = %i, weight = %f \n&quot;</span>, splineNum, <a class="code" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a>, gpu_paramNo_arr[splineNum], <a class="code" href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a>[Param], segment, tex1Dfetch&lt;float&gt;(<a class="code" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a>, segment_X), tex1Dfetch&lt;float&gt;(<a class="code" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a>, segment_X+1), dx, <a class="code" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a>, <a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>, gpu_weights[splineNum]);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;}</div>
<div class="ttc" id="agpuSplineUtils_8cu_html_a76574fafa48b0cba6adea505b0517004"><div class="ttname"><a href="gpuSplineUtils_8cu.html#a76574fafa48b0cba6adea505b0517004">segment_gpu</a></div><div class="ttdeci">__device__ __constant__ short int segment_gpu[160]</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00083">gpuSplineUtils.cu:83</a></div></div>
<div class="ttc" id="agpuSplineUtils_8cu_html_af2c36e71fccde8cfdfd4efcf469d6204"><div class="ttname"><a href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a></div><div class="ttdeci">__device__ __constant__ float val_gpu[160]</div><div class="ttdoc">CW: Constant memory needs to be hard-coded on compile time. Could make this texture memory instead,...</div><div class="ttdef"><b>Definition:</b> <a href="gpuSplineUtils_8cu_source.html#l00082">gpuSplineUtils.cu:82</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a552ab62a9156d3608c1cf6bd6986f867"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a552ab62a9156d3608c1cf6bd6986f867">&#9670;&nbsp;</a></span>EvalOnGPU_TF1()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__global__ void EvalOnGPU_TF1 </td>
          <td>(</td>
          <td class="paramtype">const float *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_coeffs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const short int *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const short int *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_nPoints_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_weights</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Evaluate the TF1 on the GPU Using 5th order polynomial. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00512">512</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                        {</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">//*********************************************************</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160; </div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="comment">// points per spline is the offset to skip in the index to move between splines</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> splineNum = (blockIdx.x * blockDim.x + threadIdx.x);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160; </div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  <span class="comment">// Note, the new arrays are arranged as:</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="comment">//       gpu_paramNo_arr has length = spln_counter (keeps track of which parameter we&#39;re using on this thread)</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="comment">//       gpu_coeff_x has length = n_params * spline_size</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <span class="comment">//       gpu_coeff_many has length = spln_counter * spline_size * 4</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="comment">//       ...</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="comment">//       gpu_weights has length = spln_counter * spline_size</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160; </div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="keywordflow">if</span> (splineNum &lt; <a class="code" href="gpuSplineUtils_8cu.html#a8df652f27dcffc6b349298601ed790ea">d_n_splines</a>) {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">// The is the variation itself (needed to evaluate variation - stored spline point = dx)</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> x = <a class="code" href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a>[gpu_paramNo_arr[splineNum]];</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160; </div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="comment">// Read the coefficients</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> a = gpu_coeffs[splineNum*<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>];</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> b = gpu_coeffs[splineNum*<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>+1];</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> c = gpu_coeffs[splineNum*<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>+2];</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> d = gpu_coeffs[splineNum*<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>+3];</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> e = gpu_coeffs[splineNum*<a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>+4];</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160; </div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="comment">// Match these with form in SetSplines</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">// Might not be great to have this if statement: maybe split two kernels?</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">if</span> (gpu_nPoints_arr[splineNum] == 5) {</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      gpu_weights[splineNum] = 1 + a*x + b*x*x + c*x*x*x + d*x*x*x*x + e*x*x*x*x*x;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gpu_nPoints_arr[splineNum] == 2) {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      gpu_weights[splineNum] = (x&lt;=0)*(1+a*x) + (x&gt;0)*(1+b*x);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;      printf(<span class="stringliteral">&quot;Big problems, I found a nPoints array which is not 5 or 2 on GPU!\n&quot;</span>);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    }</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160; </div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="comment">//if (splineNum &lt; 200) {</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="keywordflow">if</span> (gpu_nPoints_arr[splineNum] == 2) {</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      printf(<span class="stringliteral">&quot;splineNum = %i, spline_size=%i, paramNo = %i, variation = %f, a = %f, b = %f, c = %f, d = %f, e = %f, weight = %f\n&quot;</span>, splineNum, <a class="code" href="gpuSplineUtils_8cu.html#ae11082fcc44d3cf2e38cb74043fd7835">d_spline_size</a>, gpu_paramNo_arr[splineNum], x, a, b, c, d, e, gpu_weights[splineNum] );</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    }</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  }</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ae09038165064bd9d6a8acd2d2da21796"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae09038165064bd9d6a8acd2d2da21796">&#9670;&nbsp;</a></span>EvalOnGPU_TotWeight()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__global__ void EvalOnGPU_TotWeight </td>
          <td>(</td>
          <td class="paramtype">const float *__restrict__&#160;</td>
          <td class="paramname"><em>gpu_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const cudaTextureObject_t __restrict__&#160;</td>
          <td class="paramname"><em>text_nParamPerEvent</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>KS: Evaluate the total spline event weight on the GPU, as in most cases GPU is faster, even more this significant reduce memory transfer from GPU to CPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00562">562</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                                                              {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment">//*********************************************************</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> EventNum = (blockIdx.x * blockDim.x + threadIdx.x);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="comment">//KS: Accessing shared memory is much much faster than global memory hence we use shared memory for calculation and then write to global memory</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  __shared__ <span class="keywordtype">float</span> shared_total_weights[<a class="code" href="gpuUtils_8cuh.html#a393d21a8f493c2561a0ae703973dccc2">_BlockSize_</a>];</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordflow">if</span>(EventNum &lt; <a class="code" href="gpuSplineUtils_8cu.html#ad333bfa4035ada9207fc1df19272c4e2">d_n_events</a>) <span class="comment">//stopping condition</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  {</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    shared_total_weights[threadIdx.x] = 1.f;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> EventOffset = 2*EventNum;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span> = 0; id &lt; tex1Dfetch&lt;unsigned int&gt;(<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>, EventOffset); ++id)</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    {</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      shared_total_weights[threadIdx.x] *= gpu_weights[tex1Dfetch&lt;unsigned int&gt;(<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>, EventOffset+1) + id];</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="preprocessor">      #ifdef DEBUG</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;      printf(<span class="stringliteral">&quot;Event = %i, Spline_Num = %i, gpu_weights = %f \n&quot;</span>,</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;              EventNum, tex1Dfetch&lt;unsigned int&gt;(<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>, 2*EventNum+1) + <span class="keywordtype">id</span>, gpu_weights[tex1Dfetch&lt;unsigned int&gt;(<a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a>, 2*EventNum+1) + <span class="keywordtype">id</span>];</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="preprocessor">      #endif</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    }</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    gpu_total_weights[EventNum] = shared_total_weights[threadIdx.x];</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  }</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;}</div>
<div class="ttc" id="agpuUtils_8cuh_html_a393d21a8f493c2561a0ae703973dccc2"><div class="ttname"><a href="gpuUtils_8cuh.html#a393d21a8f493c2561a0ae703973dccc2">_BlockSize_</a></div><div class="ttdeci">#define _BlockSize_</div><div class="ttdoc">KS: Need it for shared memory, there is way to use dynamic shared memory but I am lazy right now.</div><div class="ttdef"><b>Definition:</b> <a href="gpuUtils_8cuh_source.html#l00021">gpuUtils.cuh:21</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a619be845847738447535c5628ff72c4c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a619be845847738447535c5628ff72c4c">&#9670;&nbsp;</a></span>InitGPU_Segments()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void InitGPU_Segments </td>
          <td>(</td>
          <td class="paramtype">short int **&#160;</td>
          <td class="paramname"><em>segment</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocate memory for spline segments. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00232">232</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                                                    {</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">// *******************************************</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="comment">//KS: Rather than allocate memory in standard way this fancy cuda tool allows to pin host memory which make memory transfer faster</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  cudaMallocHost((<span class="keywordtype">void</span> **) segment, <a class="code" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a1d9ccd919e57eb2e2939932bca23e205"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1d9ccd919e57eb2e2939932bca23e205">&#9670;&nbsp;</a></span>InitGPU_SepMany()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void InitGPU_SepMany </td>
          <td>(</td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_x_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_many_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int **&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int **&#160;</td>
          <td class="paramname"><em>gpu_nKnots_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>cpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n_events</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int **&#160;</td>
          <td class="paramname"><em>gpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>sizeof_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>n_splines</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>Eve_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialiser when using the x array and combined y,b,c,d array. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00112">112</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                                        {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="comment">// Allocate chunks of memory to GPU</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_paramNo_arr, n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_nKnots_arr, n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160; </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_x_array, Eve_size*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_many_array, <a class="code" href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a>*sizeof_array*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="comment">// Allocate memory for the array of weights to be returned to CPU</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_weights, n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="comment">//KS: Rather than allocate memory in standard way this fancy cuda tool allows to pin host memory which make memory transfer faster</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  cudaMallocHost((<span class="keywordtype">void</span> **) cpu_total_weights, n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="comment">//KS: Allocate memory for the array of total weights to be returned to CPU</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_total_weights, n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">//KS: Allocate memory for the map keeping track how many splines each parameter has</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_nParamPerEvent, 2*n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  </div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  </div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="comment">// Print allocation info to user</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  printf(<span class="stringliteral">&quot;  Allocated %i entries for paramNo and nKnots arrays, size = %f MB\n&quot;</span>, n_splines, <span class="keywordtype">double</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>)*n_splines+<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)*n_splines)/1.E6);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  printf(<span class="stringliteral">&quot;  Allocated %i entries for x coeff arrays, size = %f MB\n&quot;</span>, Eve_size, <span class="keywordtype">double</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*Eve_size)/1.E6);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  printf(<span class="stringliteral">&quot;  Allocated %i entries for {ybcd} coeff arrays, size = %f MB\n&quot;</span>, <a class="code" href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a>*sizeof_array, <span class="keywordtype">double</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*<a class="code" href="SplineCommon_8h.html#a283177311bade7400c6088e8fad71a1f">_nCoeff_</a>*sizeof_array)/1.E6);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="comment">//KS: Ask CUDA about memory usage</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <a class="code" href="gpuUtils_8cu.html#a5cfcf006bd817b3cff5da08c7f0ecb5e">checkGpuMem</a>();</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <a class="code" href="gpuUtils_8cu.html#acbef44018c81d3830eb03d342bd55dd0">PrintNdevices</a>();</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;}</div>
<div class="ttc" id="agpuUtils_8cu_html_a5cfcf006bd817b3cff5da08c7f0ecb5e"><div class="ttname"><a href="gpuUtils_8cu.html#a5cfcf006bd817b3cff5da08c7f0ecb5e">checkGpuMem</a></div><div class="ttdeci">void checkGpuMem()</div><div class="ttdoc">KS: Get some fancy info about VRAM usage.</div><div class="ttdef"><b>Definition:</b> <a href="gpuUtils_8cu_source.html#l00045">gpuUtils.cu:45</a></div></div>
<div class="ttc" id="agpuUtils_8cu_html_acbef44018c81d3830eb03d342bd55dd0"><div class="ttname"><a href="gpuUtils_8cu.html#acbef44018c81d3830eb03d342bd55dd0">PrintNdevices</a></div><div class="ttdeci">void PrintNdevices()</div><div class="ttdoc">KS: Get some fancy info about GPU.</div><div class="ttdef"><b>Definition:</b> <a href="gpuUtils_8cu_source.html#l00063">gpuUtils.cu:63</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a477d39804560c8f066b91a5f79fbfa0b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a477d39804560c8f066b91a5f79fbfa0b">&#9670;&nbsp;</a></span>InitGPU_TF1()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void InitGPU_TF1 </td>
          <td>(</td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_coeffs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int **&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int **&#160;</td>
          <td class="paramname"><em>gpu_nPoints_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>cpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n_events</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int **&#160;</td>
          <td class="paramname"><em>gpu_nParamPerEvent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>n_splines</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialiser when using the x array and combined y,b,c,d array. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00174">174</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                                                  {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="comment">// Holds the parameter number</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_paramNo_arr, n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="comment">// Holds the number of points</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_nPoints_arr, n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160; </div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="comment">// Holds the coefficients (5th order polynomial and constant term == 1) -&gt; 5</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_coeffs, 5*n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="comment">// Allocate memory for the array of weights to be returned to CPU</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_weights, n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="preprocessor">#ifndef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="comment">//KS: Rather than allocate memory in standard way this fancy cuda tool allows to pin host memory which make memory transfer faster</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  cudaMallocHost((<span class="keywordtype">void</span> **) cpu_total_weights, n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="comment">//KS: Allocate memory for the array of total weights to be returned to CPU</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_total_weights, n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="comment">//KS: Allocate memory for the map keeping track how many splines each parameter has</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  cudaMalloc((<span class="keywordtype">void</span> **) gpu_nParamPerEvent, 2*n_events*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="comment">// Print allocation info to user</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  printf(<span class="stringliteral">&quot;  Allocated %i entries for paramNo and nPoints arrays, size = %f MB\n&quot;</span>, n_splines, <span class="keywordtype">double</span>(2.0*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*n_splines)/1.E6);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  printf(<span class="stringliteral">&quot;  Allocated %i entries for coefficient arrays, size = %f MB\n&quot;</span>, 5*n_splines, <span class="keywordtype">double</span>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*5*n_splines)/1.E6);</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="comment">//KS: Ask CUDA about memory usage</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  <a class="code" href="gpuUtils_8cu.html#a5cfcf006bd817b3cff5da08c7f0ecb5e">checkGpuMem</a>();</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <a class="code" href="gpuUtils_8cu.html#acbef44018c81d3830eb03d342bd55dd0">PrintNdevices</a>();</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acc3b24da038d746b5ccfcee61ba26b90"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc3b24da038d746b5ccfcee61ba26b90">&#9670;&nbsp;</a></span>InitGPU_Vals()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void InitGPU_Vals </td>
          <td>(</td>
          <td class="paramtype">float **&#160;</td>
          <td class="paramname"><em>vals</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00241">241</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                                         {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">// *******************************************</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="comment">//KS: Rather than allocate memory in standard way this fancy cuda tool allows to pin host memory which make memory transfer faster</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  cudaMallocHost((<span class="keywordtype">void</span> **) vals, <a class="code" href="gpuSplineUtils_8cu.html#a466f32a4912da866d5014fd8cdbd06a4">_N_SPLINES_</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aed019a3225e3b5495de177e61dc3254a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed019a3225e3b5495de177e61dc3254a">&#9670;&nbsp;</a></span>RunGPU_SepMany()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void RunGPU_SepMany </td>
          <td>(</td>
          <td class="paramtype">const short int *&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned int *&#160;</td>
          <td class="paramname"><em>gpu_nKnots_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>gpu_coeff_many</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>cpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>vals</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int *&#160;</td>
          <td class="paramname"><em>segment</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned int&#160;</td>
          <td class="paramname"><em>h_n_splines</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run the GPU code for the separate many arrays. As in separate {x}, {y,b,c,d} arrays Pass the segment and the parameter values (binary search already performed in samplePDFND::FindSplineSegment() </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00591">591</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                                    {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="comment">// *****************************************</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160; </div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;  dim3 block_size;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  dim3 grid_size;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  block_size.x = <a class="code" href="gpuUtils_8cuh.html#a393d21a8f493c2561a0ae703973dccc2">_BlockSize_</a>;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  grid_size.x = (h_n_splines / block_size.x) + 1;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160; </div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;  <span class="comment">// Copy the segment values to the GPU (segment_gpu), which is h_n_params long</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#a76574fafa48b0cba6adea505b0517004">segment_gpu</a>, segment, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span> <span class="keywordtype">int</span>));</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160; </div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  <span class="comment">// Copy the parameter values values to the GPU (vals_gpu), which is h_n_params long</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a>, vals, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160; </div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nGPU DEBUGGING ENABLED\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  printf(<span class="stringliteral">&quot;block_size.x = %i, grid_size.x = %i \n&quot;</span>, block_size.x, grid_size.x);</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  printf(<span class="stringliteral">&quot;RunGPU_SepMany segments\n&quot;</span>);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>; i++) {</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    printf(<span class="stringliteral">&quot;val[%i] = %f in segment %i\n&quot;</span>, i, vals[i], segment[i]);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  }</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  printf(<span class="stringliteral">&quot;nParams = %i, n_splines = %i&quot;</span>, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>, h_n_splines);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nAM NOW CALLING KERNEL\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160; </div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="comment">// Set the cache config to prefer L1 for the kernel</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="comment">//cudaFuncSetCacheConfig(EvalOnGPU_SepMany, cudaFuncCachePreferL1);</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;  EvalOnGPU_SepMany&lt;&lt;&lt;grid_size, block_size&gt;&gt;&gt;(</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;      gpu_paramNo_arr,</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;      gpu_nKnots_arr,</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160; </div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      gpu_coeff_many,</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160; </div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      gpu_weights,</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <a class="code" href="gpuSplineUtils_8cu.html#a20b9e0707c409d990103a531cee49ce0">text_coeff_x</a></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;      );</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160; </div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  printf(<span class="stringliteral">&quot;Evaluated kernel with SUCCESS (drink beer)\n&quot;</span>);</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160; </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment">//KS: We can either copy gpu_weight and calculate total weight in reweighting loop, or not copy and calculate total weight stall at GPU, which means less memory transfer</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="preprocessor">#ifdef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="comment">// Here we have to make a somewhat large GPU-&gt;CPU transfer because it&#39;s all the splines&#39; response</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  cudaMemcpy(cpu_weights, gpu_weights, h_n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), cudaMemcpyDeviceToHost);</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  printf(<span class="stringliteral">&quot;Copied GPU weights to CPU with SUCCESS (drink more beer)\n&quot;</span>);</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  printf(<span class="stringliteral">&quot;Released calculated response from GPU with SUCCESS (drink most beer)\n&quot;</span>);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160; </div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">//KS: Else calculate Total Weight</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;  grid_size.x = (<a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a> / block_size.x) + 1;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160; </div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nGPU DEBUGGING ENABLED\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  printf(<span class="stringliteral">&quot;block_size.x = %i, grid_size.x = %i \n&quot;</span>, block_size.x, grid_size.x);</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  printf(<span class="stringliteral">&quot;RunGPU_TotWeight\n&quot;</span>);</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160; </div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;  printf(<span class="stringliteral">&quot;nEvents = %i, n_splines = %i, d_n_params&quot;</span>, <a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>, h_n_splines, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>);</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nI AM NOW CALLING KERNEL\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  EvalOnGPU_TotWeight&lt;&lt;&lt;grid_size, block_size&gt;&gt;&gt;(</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;      gpu_weights,</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;      gpu_total_weights,</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;      <a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;      );</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  printf(<span class="stringliteral">&quot;Evaluated kernel with SUCCESS (drink tea)\n&quot;</span>);</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="comment">//KS: Here we have to make a somewhat large GPU-&gt;CPU transfer because it is proportional to number of events</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="comment">//KS: Normally code wait for memory transfer to finish before moving further cudaMemcpyAsync means we will continue to execute code and in a meantime keep copying stuff.</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  cudaMemcpyAsync(cpu_total_weights, gpu_total_weights, <a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), cudaMemcpyDeviceToHost, 0);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  printf(<span class="stringliteral">&quot;Copied GPU total weights to CPU with SUCCESS (drink moar tea)\n&quot;</span>);</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;  printf(<span class="stringliteral">&quot;Released calculated response from GPU with SUCCESS (drink most tea)\n&quot;</span>);</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7036492f5c28b1a79444ef9ed1def495"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7036492f5c28b1a79444ef9ed1def495">&#9670;&nbsp;</a></span>RunGPU_TF1()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void RunGPU_TF1 </td>
          <td>(</td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>gpu_coeffs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const short int *&#160;</td>
          <td class="paramname"><em>gpu_paramNo_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const short int *&#160;</td>
          <td class="paramname"><em>gpu_nPoints_arr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>gpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>cpu_total_weights</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>vals</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned int&#160;</td>
          <td class="paramname"><em>h_n_splines</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run the GPU code for the TF1. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00698">698</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                                    {</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">// *****************************************</span></div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;  dim3 block_size;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;  dim3 grid_size;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160; </div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;  block_size.x = <a class="code" href="gpuUtils_8cuh.html#a393d21a8f493c2561a0ae703973dccc2">_BlockSize_</a>;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  grid_size.x = (h_n_splines / block_size.x) + 1;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160; </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <span class="comment">// Copy the parameter values values to the GPU (vals_gpu), which is h_n_params long</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  cudaMemcpyToSymbol(<a class="code" href="gpuSplineUtils_8cu.html#af2c36e71fccde8cfdfd4efcf469d6204">val_gpu</a>, vals, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160; </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nGPU DEBUGGING ENABLED\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  printf(<span class="stringliteral">&quot;block_size.x = %i, grid_size.x = %i \n&quot;</span>, block_size.x, grid_size.x);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  printf(<span class="stringliteral">&quot;RunGPU_TF1 segments\n&quot;</span>);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>; i++) {</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    printf(<span class="stringliteral">&quot;val[%i] = %f \n&quot;</span>, i, vals[i]);</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  }</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  printf(<span class="stringliteral">&quot;nParams = %i, n_splines = %i&quot;</span>, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>, h_n_splines);</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nAM NOW CALLING KERNEL\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160; </div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  <span class="comment">// Set the cache config to prefer L1 for the kernel</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  <span class="comment">//cudaFuncSetCacheConfig(EvalOnGPU_TF1, cudaFuncCachePreferL1);</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  EvalOnGPU_TF1&lt;&lt;&lt;grid_size, block_size&gt;&gt;&gt;(</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;      gpu_coeffs,</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;      gpu_paramNo_arr,</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;      gpu_nPoints_arr,</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;      gpu_weights</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;      );</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  printf(<span class="stringliteral">&quot;Evaluated TF1 kernel with SUCCESS (drink beer)\n&quot;</span>);</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  </div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment">//KS: We can either copy gpu_weight and calculate total weight in reweighting loop, or not copy and calculate total weight stall at GPU, which means less memory transfer</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="preprocessor">#ifdef Weight_On_SplineBySpline_Basis</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="comment">// Here we have to make a somewhat large GPU-&gt;CPU transfer because it&#39;s all the splines&#39; response</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  cudaMemcpy(cpu_weights, gpu_weights, h_n_splines*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), cudaMemcpyDeviceToHost);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;  </div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;  printf(<span class="stringliteral">&quot;Copied TF1 GPU weights to CPU with SUCCESS (drink moar beer)\n&quot;</span>);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  printf(<span class="stringliteral">&quot;Released TF1 calculated response from GPU with SUCCESS (drink most beer)\n&quot;</span>);</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160; </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="comment">//KS: Else calculate Total Weight</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  grid_size.x = (<a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a> / block_size.x) + 1;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160; </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nGPU DEBUGGING ENABLED\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  printf(<span class="stringliteral">&quot;block_size.x = %i, grid_size.x = %i \n&quot;</span>, block_size.x, grid_size.x);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  printf(<span class="stringliteral">&quot;RunGPU_TotWeight\n&quot;</span>);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160; </div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  printf(<span class="stringliteral">&quot;nEvents = %i, n_splines = %i, d_n_params&quot;</span>, <a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>, h_n_splines, <a class="code" href="gpuSplineUtils_8cu.html#a374cb9eb9a8a9a79fa09a0b916acf166">h_n_params</a>);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;  printf(<span class="stringliteral">&quot;\n***********************\nI AM NOW CALLING KERNEL\n***********************\n&quot;</span>);</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  EvalOnGPU_TotWeight&lt;&lt;&lt;grid_size, block_size&gt;&gt;&gt;(</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      gpu_weights,</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      gpu_total_weights,</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;      <a class="code" href="gpuSplineUtils_8cu.html#af7cc79856fc0663cb8fd2a9480cccfad">text_nParamPerEvent</a></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      );</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  printf(<span class="stringliteral">&quot;Evaluated kernel with SUCCESS (drink tea)\n&quot;</span>);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  <span class="comment">//KS: Here we have to make a somewhat large GPU-&gt;CPU transfer because it is proportional to number of events</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  <span class="comment">//KS: In the future it might be worth to calculate only weight for events which have splines, this should reduce memory transfer</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;  cudaMemcpy(cpu_total_weights, gpu_total_weights, <a class="code" href="gpuSplineUtils_8cu.html#abc47d2cce54457c72a996222ec0a9ce4">h_n_events</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), cudaMemcpyDeviceToHost);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="preprocessor">  #ifdef DEBUG</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  <a class="code" href="gpuUtils_8cuh.html#a0345e89c96b417069f1e64674cc77318">CudaCheckError</a>();</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  printf(<span class="stringliteral">&quot;Copied GPU total weights to CPU with SUCCESS (drink moar tea)\n&quot;</span>);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  printf(<span class="stringliteral">&quot;Released calculated response from GPU with SUCCESS (drink most tea)\n&quot;</span>);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="preprocessor">  #endif</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a953e5c5aecebd908f5d8c6ad64de482c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a953e5c5aecebd908f5d8c6ad64de482c">&#9670;&nbsp;</a></span>SynchroniseSplines()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__host__ void SynchroniseSplines </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Make sure all Cuda threads finished execution. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00797">797</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>
<div class="fragment"><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                                   {</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  cudaDeviceSynchronize();</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ad333bfa4035ada9207fc1df19272c4e2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad333bfa4035ada9207fc1df19272c4e2">&#9670;&nbsp;</a></span>d_n_events</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__device__ __constant__ int d_n_events</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Number of events living on GPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00079">79</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="a8df652f27dcffc6b349298601ed790ea"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8df652f27dcffc6b349298601ed790ea">&#9670;&nbsp;</a></span>d_n_splines</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__device__ __constant__ unsigned int d_n_splines</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Number of splines living on GPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00074">74</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="ae11082fcc44d3cf2e38cb74043fd7835"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae11082fcc44d3cf2e38cb74043fd7835">&#9670;&nbsp;</a></span>d_spline_size</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__device__ __constant__ short int d_spline_size</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Size of splines living on GPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00076">76</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="abc47d2cce54457c72a996222ec0a9ce4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abc47d2cce54457c72a996222ec0a9ce4">&#9670;&nbsp;</a></span>h_n_events</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int h_n_events = -1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of events living on CPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00092">92</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="a374cb9eb9a8a9a79fa09a0b916acf166"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a374cb9eb9a8a9a79fa09a0b916acf166">&#9670;&nbsp;</a></span>h_n_params</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int h_n_params = -1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of params living on CPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00089">89</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="a43574e01dd0d1f01bd8dd261ab5521e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43574e01dd0d1f01bd8dd261ab5521e8">&#9670;&nbsp;</a></span>h_spline_size</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">short int h_spline_size = -1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of splines living on CPU. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00087">87</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="a76574fafa48b0cba6adea505b0517004"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a76574fafa48b0cba6adea505b0517004">&#9670;&nbsp;</a></span>segment_gpu</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__device__ __constant__ short int segment_gpu[160]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00083">83</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="a20b9e0707c409d990103a531cee49ce0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a20b9e0707c409d990103a531cee49ce0">&#9670;&nbsp;</a></span>text_coeff_x</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cudaTextureObject_t text_coeff_x = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>KS: Textures are L1 cache variables which are well optimised for fetching. Make texture only for variables you often access but rarely overwrite. There are limits on texture memory so don't use huge arrays. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00099">99</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="af7cc79856fc0663cb8fd2a9480cccfad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af7cc79856fc0663cb8fd2a9480cccfad">&#9670;&nbsp;</a></span>text_nParamPerEvent</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cudaTextureObject_t text_nParamPerEvent = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>KS: Map keeping track how many parameters applies to each event, we keep two numbers here {number of splines per event, index where splines start for a given event}. </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00102">102</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
<a id="af2c36e71fccde8cfdfd4efcf469d6204"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af2c36e71fccde8cfdfd4efcf469d6204">&#9670;&nbsp;</a></span>val_gpu</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__device__ __constant__ float val_gpu[160]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>CW: Constant memory needs to be hard-coded on compile time. Could make this texture memory instead, but don't care enough right now... </p>

<p class="definition">Definition at line <a class="el" href="gpuSplineUtils_8cu_source.html#l00082">82</a> of file <a class="el" href="gpuSplineUtils_8cu_source.html">gpuSplineUtils.cu</a>.</p>

</div>
</div>
</div><!-- contents -->
<footer class="mach3-footer" style="text-align: center;">
    <div style="margin-bottom: 15px;">
        <span style="font-weight: bold;">The MaCh3 Collaboration</span>
    </div>
    <div style="margin-bottom: 10px;">
        <span>Select Software Version: </span>
        <select id="versionSelector" onchange="window.location.href=this.value" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="">-- Select --</option>
            <option value="https://mach3-software.github.io/MaCh3/">develop</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.2.0/index.html">v2.2.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.1.0/index.html">v2.1.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v2.0.0/index.html">v2.0.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.5.0/index.html">v1.5.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.4.0/index.html">v1.4.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.3.0/index.html">v1.3.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.2.0/index.html">v1.2.0</option>
            <option value="https://mach3-software.github.io/MaCh3/.Archive/v1.1.0/index.html">v1.1.0</option>
        </select>
    </div>
    <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
        Documentation generated with <a href="https://www.doxygen.nl/" target="_blank" style="color: #666;">Doxygen</a>
    </div>
</footer>
