\hypertarget{MaCh3Factory_8cpp_source}{}\doxysection{Ma\+Ch3\+Factory.\+cpp}
\label{MaCh3Factory_8cpp_source}\index{/home/runner/work/MaCh3/MaCh3/mcmc/MaCh3Factory.cpp@{/home/runner/work/MaCh3/MaCh3/mcmc/MaCh3Factory.cpp}}
\mbox{\hyperlink{MaCh3Factory_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00001}00001\ \textcolor{comment}{//\ MaCh3\ includes}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00002}00002\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{MaCh3Factory_8h}{mcmc/MaCh3Factory.h}}"{}}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00003}00003\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00004}00004\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00005}00005\ \textcolor{comment}{//\ ********************************************}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00006}\mbox{\hyperlink{MaCh3Factory_8cpp_adc486d9a678970321030996bd965de77}{00006}}\ std::unique\_ptr<FitterBase>\ \mbox{\hyperlink{MaCh3Factory_8cpp_adc486d9a678970321030996bd965de77}{MaCh3FitterFactory}}(\mbox{\hyperlink{classmanager}{manager}}\ *fitMan,\ std::vector<samplePDFBase*>\&\ Samples,\ std::vector<covarianceBase*>\&\ Covariances)\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00007}00007\ \textcolor{comment}{//\ ********************************************}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00008}00008\ \ \ std::unique\_ptr<FitterBase>\ MaCh3Fitter\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00009}00009\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00010}00010\ \ \ \textcolor{keyword}{auto}\ Algorithm\ =\ GetFromManager<std::string>(fitMan-\/>\mbox{\hyperlink{classmanager_ab3999cc856ede72b37f68bdb28bd5520}{raw}}()[\textcolor{stringliteral}{"{}General"{}}][\textcolor{stringliteral}{"{}FittingAlgorithm"{}}],\ \textcolor{stringliteral}{"{}MCMC"{}});}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00012}00012\ \ \ \textcolor{keywordflow}{if}(Algorithm\ ==\ \textcolor{stringliteral}{"{}MCMC"{}})\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00013}00013\ \ \ \ \ MaCh3Fitter\ =\ std::make\_unique<mcmc>(fitMan);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00014}00014\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (Algorithm\ ==\ \textcolor{stringliteral}{"{}PSO"{}})\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00015}00015\ \ \ \ \ MaCh3Fitter\ =\ std::make\_unique<PSO>(fitMan);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00016}00016\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (Algorithm\ ==\ \textcolor{stringliteral}{"{}Minuit2"{}})\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00017}00017\ \textcolor{preprocessor}{\ \ \ \ \#ifdef\ MaCh3\_MINUIT2}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00018}00018\ \ \ \ \ MaCh3Fitter\ =\ std::make\_unique<MinuitFit>(fitMan);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00019}00019\ \textcolor{preprocessor}{\ \ \ \ \#else}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00020}00020\ \ \ \ \ \mbox{\hyperlink{MaCh3Logger_8h_a61052119a625282d0ec6d4a97adf3ee2}{MACH3LOG\_ERROR}}(\textcolor{stringliteral}{"{}Trying\ to\ use\ Minuit2\ however\ MaCh3\ was\ compiled\ without\ Minuit2\ support"{}});}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00021}00021\ \ \ \ \ \textcolor{keywordflow}{throw}\ \mbox{\hyperlink{classMaCh3Exception}{MaCh3Exception}}(\_\_FILE\_\_\ ,\ \_\_LINE\_\_\ );}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00022}00022\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00023}00023\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00024}00024\ \ \ \ \ \mbox{\hyperlink{MaCh3Logger_8h_a61052119a625282d0ec6d4a97adf3ee2}{MACH3LOG\_ERROR}}(\textcolor{stringliteral}{"{}You\ want\ to\ use\ algorithm\ \{\},\ I\ don't\ recognize\ it,\ sry"{}},\ Algorithm);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00025}00025\ \ \ \ \ \textcolor{keywordflow}{throw}\ \mbox{\hyperlink{classMaCh3Exception}{MaCh3Exception}}(\_\_FILE\_\_\ ,\ \_\_LINE\_\_\ );}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00026}00026\ \ \ \}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00028}00028\ \ \ \textcolor{comment}{//KS:\ Adding\ samples\ and\ covariances\ to\ the\ Fitter\ class\ could\ be\ in\ the\ factory}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00029}00029\ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i\ =\ 0;\ Samples.size();\ i++)}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00030}00030\ \ \ \ \ MaCh3Fitter-\/>addSamplePDF(Samples[i]);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00031}00031\ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i\ =\ 0;\ Covariances.size();\ i++)}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00032}00032\ \ \ \ \ MaCh3Fitter-\/>addSystObj(Covariances[i]);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00034}00034\ \ \ \textcolor{keywordflow}{return}\ MaCh3Fitter;}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00035}00035\ \}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00036}00036\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00037}00037\ \textcolor{comment}{//\ ********************************************}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00038}\mbox{\hyperlink{MaCh3Factory_8cpp_a37464d72da10c4e30eba841888416f40}{00038}}\ \mbox{\hyperlink{classcovarianceXsec}{covarianceXsec}}*\ \mbox{\hyperlink{MaCh3Factory_8cpp_a37464d72da10c4e30eba841888416f40}{MaCh3CovarianceFactory}}(\mbox{\hyperlink{classmanager}{manager}}\ *FitManager,\ \textcolor{keyword}{const}\ std::string\&\ PreFix)\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00039}00039\ \textcolor{comment}{//\ ********************************************}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00040}00040\ \ \ \textcolor{comment}{//\ config\ for\ our\ matrix}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00041}00041\ \ \ YAML::Node\ Settings\ =\ FitManager-\/>\mbox{\hyperlink{classmanager_ab3999cc856ede72b37f68bdb28bd5520}{raw}}()[\textcolor{stringliteral}{"{}General"{}}][\textcolor{stringliteral}{"{}Systematics"{}}];}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00042}00042\ \ \ \textcolor{keyword}{auto}\ CovMatrixName\ =\ Settings[std::string(PreFix)\ +\ \textcolor{stringliteral}{"{}CovName"{}}].as<std::string>();}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00043}00043\ \ \ \mbox{\hyperlink{MaCh3Logger_8h_a95fa4dffc648e4c5536c9292c2bdcac3}{MACH3LOG\_INFO}}(\textcolor{stringliteral}{"{}Initialising\ \{\}\ matrix"{}},\ CovMatrixName);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00045}00045\ \ \ \textcolor{comment}{//\ yaml\ files\ initialising\ out\ matrix}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00046}00046\ \ \ \textcolor{keyword}{auto}\ CovMatrixFile\ =\ Settings[std::string(PreFix)\ +\ \textcolor{stringliteral}{"{}CovFile"{}}].as<std::vector<std::string>>();}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00047}00047\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00048}00048\ \ \ \textcolor{comment}{//\ PCA\ threshold,\ -\/1\ means\ no\ pca}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00049}00049\ \ \ \textcolor{keyword}{auto}\ PCAThreshold\ =\ GetFromManager<int>(Settings[std::string(PreFix)\ +\ \textcolor{stringliteral}{"{}PCAThreshold"{}}],\ -\/1);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00050}00050\ \ \ \textcolor{comment}{//\ do\ we\ pca\ whole\ matrix\ or\ only\ submatrix}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00051}00051\ \ \ \textcolor{keyword}{auto}\ PCAParamRegion\ =\ GetFromManager<std::vector<int>>(Settings[std::string(PreFix)\ +\ \textcolor{stringliteral}{"{}PCAParams"{}}],\ \{-\/999,\ -\/999\});}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00054}00054\ \ \ \mbox{\hyperlink{classcovarianceXsec}{covarianceXsec}}*\ xsec\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classcovarianceXsec}{covarianceXsec}}(CovMatrixFile,\ \textcolor{stringliteral}{"{}xsec\_cov"{}},\ PCAThreshold,\ PCAParamRegion[0],\ PCAParamRegion[1]);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00055}00055\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00056}00056\ \ \ \textcolor{comment}{//\ Fill\ the\ parameter\ values\ with\ their\ nominal\ values}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00057}00057\ \ \ \textcolor{comment}{//\ should\ \_ALWAYS\_\ be\ done\ before\ overriding\ with\ fix\ or\ flat}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00058}00058\ \ \ xsec-\/>setParameters();}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00060}00060\ \ \ \textcolor{keyword}{auto}\ FixParams\ =\ GetFromManager<std::vector<std::string>>(Settings[std::string(PreFix)\ +\ \textcolor{stringliteral}{"{}FixParams"{}}],\ \{\});}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00062}00062\ \ \ \textcolor{comment}{//\ Fixed\ xsec\ parameters\ loop}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00063}00063\ \ \ \textcolor{keywordflow}{if}\ (FixParams.size()\ ==\ 1\ \&\&\ FixParams.at(0)\ ==\ \textcolor{stringliteral}{"{}All"{}})\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00064}00064\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ xsec-\/>GetNumParams();\ j++)\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00065}00065\ \ \ \ \ \ \ xsec-\/>toggleFixParameter(j);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00066}00066\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00067}00067\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00068}00068\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ FixParams.size();\ j++)\ \{}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00069}00069\ \ \ \ \ \ \ xsec-\/>toggleFixParameter(FixParams.at(j));}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00070}00070\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00071}00071\ \ \ \}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00072}00072\ \ \ \textcolor{comment}{//Global\ step\ scale\ for\ matrix}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00073}00073\ \ \ \textcolor{keyword}{auto}\ StepScale\ =\ Settings[std::string(PreFix)\ +\ \textcolor{stringliteral}{"{}StepScale"{}}].as<\textcolor{keywordtype}{double}>();}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00074}00074\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00075}00075\ \ \ xsec-\/>setStepScale(StepScale);}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00076}00076\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00077}00077\ \ \ \textcolor{comment}{//\ Adaptive\ MCMC\ stuff}}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00078}00078\ \ \ \textcolor{keywordflow}{if}(FitManager-\/>\mbox{\hyperlink{classmanager_ab3999cc856ede72b37f68bdb28bd5520}{raw}}()[\textcolor{stringliteral}{"{}AdaptionOptions"{}}])}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00079}00079\ \ \ \ \ xsec-\/>initialiseAdaption(FitManager-\/>\mbox{\hyperlink{classmanager_ab3999cc856ede72b37f68bdb28bd5520}{raw}}());}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00080}00080\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00081}00081\ \ \ \mbox{\hyperlink{MaCh3Logger_8h_a95fa4dffc648e4c5536c9292c2bdcac3}{MACH3LOG\_INFO}}(\textcolor{stringliteral}{"{}Factory\ successful"{}});}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00082}00082\ }
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00083}00083\ \ \ \textcolor{keywordflow}{return}\ xsec;}
\DoxyCodeLine{\Hypertarget{MaCh3Factory_8cpp_source_l00084}00084\ \}}

\end{DoxyCode}
